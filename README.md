# Disco

Disco is a discovery and WebRTC-signaling server for Babble groups.

```bash
Discovery service for Babble

Usage:
  disco [flags]

Flags:
      --address string       Address of the server (default "localhost")
      --cert-file string     File containing TLS certificate (default "cert.pem")
      --disco-port string    Discovery API port (default "1443")
  -h, --help                 help for disco
      --key-file string      File containing certificate key (default "key.pem")
      --realm string         Administrative routing domain within the WebRTC signaling (default "office")
      --signal-port string   WebRTC-Signaling port (default "2443")
```

The discovery API and WebRTC-signaling router are exposed on different ports,
`disco-port` (default 1443) and `signal-port` (default 2443) respectively.

Both services are secured with TLS, and the same underlying certificate. The
certificate and key files are specified with `cert-file` and `key-file` options.

To get started with a localhost disco server, simply run:

```bash
make run
```

## Discovery

The discovery API offers a mechanism to create, discover, and manage Babble
groups. A Babble group defines a set of peers engaged in a Babble consensus
network.

The following sections describe the API calls using curl, but we need curl to 
trust the self-signed certificate in `test_data/cert.pem`:

```bash
export CURL_CA_BUNDLE=test_data/cert.pem
```

## Add a group

```bash
POST https://localhost:1443/group
```

```bash
 curl --location --request POST 'https://localhost:1443/group' \
--header 'Content-Type: application/json' \
--data-binary @new_group.json
```

where `new_group.json` contains the json for a new group:

```json
{
	"Name": "office group",
	"AppID": "BabbleChat",
	"Peers": [ 
		{
			"NetAddr":"thenetaddr",
			"PubKeyHex":"thepubkey",
			"Moniker":"Monica"
		}
	],
	"GenesisPeers": [
		{
			"NetAddr":"thenetaddr",
			"PubKeyHex":"thepubkey",
			"Moniker":"Monica"
		}
	]
}
```

Note that the `ID` field of the group is omitted. This is because it will be
randomly generated by the server. If the `ID` is specified, the server will 
either update the group in place, or create a new one with that ID.

## List all groups

```bash
GET https://localhost:1443/groups
```

```json
{
	"8f41c928-360b-4202-90f1-a7efa6b7ffd3": {
		"ID":"8f41c928-360b-4202-90f1-a7efa6b7ffd3",
		"Name":"office group",
		"AppID":"BabbleChat",
		"PubKey":"",
		"LastUpdated":1583773505,
		"Peers":[
			{
				"NetAddr":"thenetaddr",
				"PubKeyHex":"thepubkey",
				"Moniker":"Monica"
			}
		],
		"InitialPeers":[
			{
				"NetAddr":"thenetaddr",
				"PubKeyHex":"thepubkey",
				"Moniker":"Monica"
			}
		]
	}
}
```

## Get a specific group

```bash
GET https://localhost:1443/groups/{ID}
```

```json
{
	"ID":"8f41c928-360b-4202-90f1-a7efa6b7ffd3",
	"Name":"office group",
	"AppID":"BabbleChat",
	"PubKey":"",
	"LastUpdated":1583773505,
	"Peers":[
		{
			"NetAddr":"thenetaddr",
			"PubKeyHex":"thepubkey",
			"Moniker":"Monica"
		}
	],
	"InitialPeers":[
		{
			"NetAddr":"thenetaddr",
			"PubKeyHex":"thepubkey",
			"Moniker":"Monica"
		}
	]
}
```

## Update a group

```bash
PATCH https://localhost:1443/groups/2
```

```bash
 curl --location --request PATCH 'https://localhost:1443/group' \
--header 'Content-Type: application/json' \
--data-binary @updated_group.json
```

## Delete a group

```bash
DELETE https://localhost:1443/groups/2
```

```
The group with ID 2 has been deleted successfully
```
